name: Create Release

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Create plugin package
        run: |
          mkdir -p release-temp/onecommeOSCrouter
          
          # Copy plugin files (exclude dev files)
          cp -r impl release-temp/onecommeOSCrouter/
          cp -r web-ui release-temp/onecommeOSCrouter/
          cp -r node_modules release-temp/onecommeOSCrouter/
          cp -r tests release-temp/onecommeOSCrouter/
          cp plugin.js release-temp/onecommeOSCrouter/
          cp package.json release-temp/onecommeOSCrouter/
          cp package-lock.json release-temp/onecommeOSCrouter/
          cp README.md release-temp/onecommeOSCrouter/
          cp README.ja.md release-temp/onecommeOSCrouter/
          cp README.zh-HK.md release-temp/onecommeOSCrouter/
          cp LICENSE release-temp/onecommeOSCrouter/
          
          # Create ZIP file
          cd release-temp
          zip -r ../onecommeOSCrouter-${{ github.ref_name }}.zip onecommeOSCrouter
          cd ..
      
      - name: Extract version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          name: ${{ github.ref_name }} - OneComme OSC Router
          body: |
            ## üöÄ OneComme OSC Router ${{ github.ref_name }}
            
            Download and extract the ZIP file to your OneComme `Plugins` directory.
            
            ### üì¶ Installation
            1. Download `onecommeOSCrouter-${{ github.ref_name }}.zip`
            2. Extract to `OneComme/Plugins/` directory
            3. Ensure the folder is named exactly `onecommeOSCrouter`
            4. Restart OneComme
            5. Enable the plugin in OneComme settings
            6. Access the web interface at http://localhost:19101
            
            ### üìö Documentation
            - [English Guide](https://noodledostuff.github.io/onecommeOSCrouter/)
            - [Êó•Êú¨Ë™û„Ç¨„Ç§„Éâ](https://noodledostuff.github.io/onecommeOSCrouter/index.ja.html)
            - [ÁπÅÈ´î‰∏≠ÊñáÊåáÂçó](https://noodledostuff.github.io/onecommeOSCrouter/index.zh-HK.html)
            
            ### ‚ú® Features
            - **Advanced Message Routing**: Complex multi-condition rules with AND/OR logic
            - **Multi-Platform Support**: YouTube, Bilibili, and Niconico integration
            - **Real-Time Web Interface**: Dashboard at http://localhost:19101
            - **OSC Output**: Optimized for VRChat, OBS, and TouchDesigner
            - **Emoji Management**: Optional emoji removal from messages
            - **RESTful API**: Full programmatic control
            - **Auto-Save**: Persistent configuration and rules
            
            ### üîß Requirements
            - OneComme installed and configured
            - Node.js 16.0.0+ (bundled with OneComme)
            - OSC-enabled application (VRChat, OBS, etc.)
            
            ---
            
            **Full Changelog**: https://github.com/${{ github.repository }}/commits/${{ github.ref_name }}
          files: |
            onecommeOSCrouter-${{ github.ref_name }}.zip
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
