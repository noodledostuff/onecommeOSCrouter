# OneComme OSC Router プラグイン

*他の言語で読む: [English](README.md) | [繁體中文(香港)](README.zh-HK.md)*

**OneCommeのチャットメッセージを、VRChat、OBS、TouchDesigner、その他のクリエイティブアプリケーション向けの強力なOSCデータストリームに変換**

OneComme OSC Routerは、OneCommeのマルチプラットフォームチャットキャプチャとOSC対応アプリケーションの橋渡しをする総合的なプラグインです。YouTube、Bilibili、ニコニコからのチャットメッセージをインテリジェントに処理し、高度なルーティング機能を備えた構造化OSCメッセージに変換します。

> ⚠️ **重要**: これはOneComme専用に設計されたプラグインです。スタンドアロンアプリケーションとしては使用できず、OneCommeのインストールと実行が必要です。

---

## 🎯 このプラグインの機能

OSC Routerは、以下の機能を持つインテリジェントなミドルウェアレイヤーとして動作します：

- **キャプチャ** - OneCommeが処理するすべてのチャットメッセージをサポート対象プラットフォームから取得
- **処理** - カスタマイズ可能なフィルタリングとルーティングルールを通じてメッセージを処理
- **変換** - チャットデータをJSONペイロード付きの構造化OSCメッセージに変換
- **ルーティング** - カスタムロジックに基づいて異なるOSCエンドポイントにメッセージをルーティング
- **モニタリング** - リアルタイムデバッグと分析によるメッセージフローの監視

### 対応するOneCommeプラットフォーム

| プラットフォーム | メッセージタイプ | 特別な機能 |
|----------|---------------|------------------|
| **YouTube** | コメント、スーパーチャット、メンバーシップ | 金額検出、通貨処理、メンバーシップ階層 |
| **Bilibili** | コメント、ギフト、ガードステータス | コイン金額、ユーザーレベル、VIP検出 |
| **ニコニコ** | コメント、プレミアムユーザー | プレミアムユーザー検出、タイムスタンプ処理 |

---

## ✨ 主な機能

### 🅰️ 高度なメッセージルーティング
- **複数条件ロジック**: AND/ORロジックチェーンで複雑なルールを作成
- **プラットフォーム固有フィルタリング**: プラットフォーム、ユーザーステータス、メッセージ内容、または金額に基づいてルーティング
- **絵文字管理**: クリーンなテキスト出力のためチャットメッセージから絵文字コンテンツをオプションで削除
- **エンドポイントカスタマイズ**: 異なるメッセージタイプを異なるOSCアドレスに送信
- **リアルタイム処理**: ゼロレイテンシーのメッセージ変換とルーティング

### 🖥️ プロフェッショナルなウェブインターフェース
- **直感的なダッシュボード**: `http://localhost:19101`でアクセス可能なクリーンなタブ式インターフェース
- **ライブメッセージモニター**: 受信・送信OSCメッセージのリアルタイムビュー
- **ルールビルダー**: 条件テスト付きのビジュアルルール作成
- **設定管理**: 簡単なバックアップと共有のための設定のエクスポート/インポート

### 💾ž インテリジェントな永続化
- **すべて自動保存**: 設定、ルール、UI設定を自動的に保存
- **セッションの継続性**: 最後にアクティブだったタブとフォームの下書きを記憶
- **バックアップシステム**: 自動設定バックアップによるデータ損失の防止
- **マイグレーションサポート**: 設定バージョン管理によるシームレスなアップデート

### 🔧 開発者フレンドリーなアーキテクチャ
- **RESTful API**: プログラマティック制御のための完全なHTTP API
- **拡張可能な設計**: プラットフォームハンドラーを簡単に拡張可能
- **包括的なロギング**: 詳細なデバッグ出力とメッセージ追跡
- **テストスイート**: 設定とOSC信頼性のための組み込みテスト

---

## 🚀 OneComme統合ガイド

### 前提条件
- **OneComme** がインストールされ、ストリーミングプラットフォーム用に設定されていること
- **Node.js 16.0.0+**（通常OneCommeプラグインにバンドルされています）
- **OSC対応アプリケーション**（VRChat、OBS、TouchDesignerなど）

### OneCommeへのインストール

1. **プラグインのダウンロード**
   - このリポジトリをOneCommeのプラグインディレクトリにクローンまたはダウンロード
   - すべてのファイルが`onecommeOSCrouter`という名前のフォルダーにあることを確認
   - 必要な依存関係はすべてプラグインに含まれています

2. **OneCommeで有効化**
   - OneCommeを再起動して新しいプラグインを検出
   - OneCommeのプラグイン設定に移動
   - 「OneComme OSC Router」を有効化

3. **インストールの確認**
   - OneCommeのコンソールでプラグインロードメッセージを確認
   - `http://localhost:19101`にアクセスしてウェブインターフェースを開く
   - 起動時にエラーメッセージが表示されないことを確認

---

## ⚙️ 設定とセットアップ

### 初期設定

初回ロード時、プラグインは一般的なユースケースに最適化されたデフォルト設定を作成します：

**デフォルトOSC設定:**
- **ホスト**: `127.0.0.1`（ローカルマシン）
- **ポート**: `19100`（標準VRChat OSCポート）
- **ウェブインターフェース**: `http://localhost:19101`

**デフォルトメッセージルート:**
- `/onecomme/youtube/comment` → YouTubeコメント
- `/onecomme/youtube/superchat` → YouTubeスーパーチャット
- `/onecomme/bilibili/comment` → Bilibiliコメント
- `/onecomme/bilibili/gift` → Bilibiliギフト
- `/onecomme/niconico/comment` → ニコニココメント

### ウェブインターフェース概要

`http://localhost:19101`で設定インターフェースにアクセス：

#### 📊 **概要タブ**
- リアルタイムメッセージ統計
- 接続ステータスインジケーター
- 共通設定への素早いアクセス
- システムヘルスモニタリング

#### 📜 **ルールタブ**
- ビジュアルルールビルダーでルーティングルールを作成・管理
- 事前入力されたフォームを持つ専用編集モーダルを使用して**既存のルールを編集**
- トグルスイッチでルールを有効/無効化
- 確認プロンプト付きでルールを削除
- サンプルメッセージでルールをテスト
- ルールセットのインポート/エクスポート
- ルール優先順位管理

#### 📋 **ログタブ**
- 受信/送信データを表示するライブメッセージモニター
- メッセージフィルタリングと検索
- デバッグ用のログエクスポート
- ログ履歴のクリア

#### ⚙️ **設定タブ**
- OSC出力設定
- **絵文字削除**: チャットメッセージから絵文字コンテンツを削除するトグル
- ウェブインターフェース設定
- 高度な接続設定
- 設定のバックアップ/復元

---

## 🎨 カスタムルーティングルールの作成

ルールシステムにより、高度なメッセージ処理ロジックが可能になります。包括的な例を以下に示します：

### 例1: 高額寄付アラート

**目標**: 重要な寄付を特別なアラートエンドポイントにルーティング

```json
{
  "name": "高額寄付",
  "description": "大きな寄付をアラートシステムにルーティング",
  "endpoint": "/alerts/bigdonation",
  "conditions": {
    "logic": "OR",
    "groups": [
      {
        "logic": "AND",
        "conditions": [
          {"field": "service", "operator": "equals", "value": "youtube"},
          {"field": "type", "operator": "equals", "value": "superchat"},
          {"field": "amount", "operator": "greater_than", "value": "20"}
        ]
      },
      {
        "logic": "AND",
        "conditions": [
          {"field": "service", "operator": "equals", "value": "bilibili"},
          {"field": "type", "operator": "equals", "value": "gift"},
          {"field": "coins", "operator": "greater_than", "value": "100"}
        ]
      }
    ]
  },
  "fieldMappings": {
    "username": "name",
    "message": "comment",
    "value": ["amount", "coins"],
    "currency": "currency",
    "platform": "service"
  }
}
```

### 利用可能な条件演算子

| 演算子 | 説明 | 例 |
|----------|-------------|---------|
| `equals` | 完全一致 | `"service" equals "youtube"` |
| `not_equals` | 不一致 | `"type" not_equals "comment"` |
| `contains` | 文字列を含む | `"comment" contains "hello"` |
| `not_contains` | 文字列を含まない | `"comment" not_contains "spam"` |
| `greater_than` | 数値比較 | `"amount" greater_than "10"` |
| `less_than` | 数値比較 | `"amount" less_than "5"` |
| `regex` | 正規表現 | `"comment" regex "\\d+"` |
| `exists` | フィールドに値あり | `"amount" exists` |
| `not_exists` | フィールドが空 | `"gift_name" not_exists` |

---

## 📡 OSCメッセージフォーマット

プラグインから送信されるすべてのOSCメッセージには構造化JSONデータが含まれます：

### 標準メッセージ構造

```json
{
  "timestamp": "2024-09-20T08:30:01.123Z",
  "service": "youtube",
  "type": "superchat",
  "user": {
    "id": "UC1234567890",
    "name": "StreamerFan123",
    "display_name": "StreamerFan123"
  },
  "message": {
    "content": "素晴らしい配信！頑張って！",
    "id": "msg_12345"
  },
  "platform_data": {
    "amount": "5.00",
    "currency": "USD",
    "is_member": true,
    "membership_months": 6
  },
  "processing": {
    "rule_matched": "高額寄付",
    "endpoint": "/alerts/bigdonation",
    "processed_at": "2024-09-20T08:30:01.125Z"
  }
}
```

---

## 🧪 テストとデバッグ

### 組み込みテストスイート

プラグインには包括的なテストツールが含まれています：

#### 設定テスト
```bash
node tests/test-config-persistence.js
```

#### OSC信頼性テスト
```bash
node tests/test-osc-reliability.js
```

#### リアルタイムモニター
```bash
node tests/osc-monitor.js
```

#### OSCメッセージフォーマットテスト
```bash
node tests/test-osc-message-formats.js
```

---

## ❓ よくある質問（Q&A）

### Q1: スタンドアロンアプリケーションではなく、OneCommeプラグインとして実装したのはなぜですか？

**A**: OneCommeがYouTube、Bilibili、ニコニコの複雑なマルチプラットフォーム認証、メッセージ取得、レート制限、API処理をすでに解決しているのに、なぜ車輪の再発明をするのでしょうか？プラグインとして構築することで、インテリジェントなメッセージルーティングとOSC統合という私たちが最も得意とすることに集中でき、OneCommeの堅牢で実績のあるチャットキャプチャインフラストラクチャを活用できます。このアプローチには以下のメリットがあります：
- **重複する認証フローなし**: OneCommeがすべてのプラットフォームログインとAPIキーを処理
- **自動更新**: プラットフォームがAPIを変更しても、OneCommeが一度更新すればすべてのプラグインに適用
- **メンテナンスの軽減**: 各プラットフォーム用の個別APIクライアントを維持する必要なし
- **より高い信頼性**: OneCommeの実績あるメッセージキャプチャシステムはゼロから始めるより安定
- **統一された設定**: ユーザーはすでに配信用にOneCommeを設定済み - プラグインを追加するだけ

### Q2: OneCommeなしでこのプラグインを使用できますか？

**A**: いいえ、このプラグインはOneCommeのインストールと実行が必要です。OneCommeがこのプラグインが依存するメッセージキャプチャインフラストラクチャを提供します。OneCommeをデータソース、このプラグインをそのデータをOSCメッセージに変換する専門プロセッサと考えてください。

### Q3: BinaryとString OSCメッセージフォーマットの違いは何ですか？

**A**: 
- **Binaryフォーマット**（デフォルト）: JSONデータをバイナリブロブとして送信。これはほとんどのアプリケーション（VRChat、TouchOSC、TouchDesignerなど）が期待する標準OSCデータフォーマットです。特別な理由がない限り、これを使用してください。
- **Stringフォーマット**: JSONをプレーンUTF-8テキスト文字列として送信。一部のカスタムOSC受信機やテキストベースのアプリケーションはこのフォーマットを必要とする場合があります。ネットワークモニターでデータが人間に読めるため、デバッグにも便利です。

OSC受信機がメッセージを正しく解析していない場合は、設定タブでフォーマットを切り替えてみてください。

### Q4: VRChatで動作しますか？

**A**: はい！デフォルトOSCポート（19100）はVRChatの標準OSC入力ポートです。プラグインはVRChatのOSCシステムで受信できる構造化JSONメッセージを送信します。カスタムルーティングルールを作成して、異なるメッセージタイプを異なるVRChatアバターパラメータやワールドトリガーに送信できます。多くのVRChatクリエイターがこのプラグインを使用して、チャットメッセージ、スーパーチャットアラート、視聴者のインタラクションをワールド内に表示しています。

### Q5: プラグインはOneCommeのパフォーマンスを低下させたり影響を与えたりしますか？

**A**: いいえ。プラグインは非同期で動作し、OneCommeのメインキャプチャシステムとは別のスレッドでメッセージを処理します。OSCメッセージ送信は非ブロッキングなので、ターゲットアプリケーションの応答が遅くても、OneCommeのチャットメッセージキャプチャ能力には影響しません。プラグインのメモリフットプリントは最小限で、メッセージロギングには効率的な循環バッファを使用しています。

### Q6: 複数のアプリケーションに同時にメッセージをルーティングできますか？

**A**: 現在、プラグインは設定で構成された単一のOSCホスト/ポートに送信します。ただし、以下のことができます：
- OSCルーティングソフトウェア（OSCRouterやChataigneなど）を使用して、メッセージを複数の宛先に再配布
- 異なるポートでプラグインの複数インスタンスを実行（コードの変更が必要）
- 異なるエンドポイントでルールを作成 - 受信アプリケーションは複数のOSCアドレスをリッスン可能

### Q7: ターゲットアプリケーションが実行されていないときメッセージはどうなりますか？

**A**: メッセージはUDP経由で送信されます。これは「ファイアアンドフォーゲット」プロトコルです。ターゲットアプリケーションが実行されていないかリッスンしていない場合：
- プラグインはメッセージを送信し続けます（ネットワークスタックによって単に破棄されます）
- プラグインにエラーは表示されません（これは通常のOSC動作です）
- ターゲットアプリケーションが起動してリッスンを開始すると、すぐに新しいメッセージを受信します
- 組み込みのOSCモニター（`npm run monitor`）を使用して、メッセージが正しく送信されていることを確認できます

### Q8: 特定のユーザーやメッセージ内容のルールを作成するにはどうすればよいですか？

**A**: ウェブインターフェース（ルールタブ）のビジュアルルールビルダーを使用するか、`routing-rules.json`を手動で編集します。ルールは以下をサポートします：
- **フィールドマッチング**: ユーザー名、メッセージ内容、寄付額、ユーザーレベル、VIPステータス
- **演算子**: equals、contains、greater_than、less_than、正規表現パターン
- **ロジック組み合わせ**: 複雑な条件のためのAND/ORロジック
- **プラットフォームフィルタリング**: YouTube専用、Bilibili専用、またはクロスプラットフォームルール

詳細な例については「カスタムルーティングルールの作成」セクションを参照してください。

---

## 📄 ライセンスとクレジット

**MITライセンス** - 完全な条件については[LICENSE](LICENSE)ファイルを参照

### サードパーティ依存関係
- **node-osc**: OSC通信ライブラリ
- **express**: ウェブサーバーフレームワーク
- **OneComme**: チャットキャプチャプラットフォーム（必須）

### 謝辞
- このプロジェクトにインスピレーションを与えたオリジナルOneComme OSCプラグインの**VirtualCastチーム**
- 拡張可能なプラグインアーキテクチャを提供するOneComme開発チーム
- プロトコル仕様とベストプラクティスを提供するOSCコミュニティ
- フィードバックと改善を提供する貢献者とユーザー

---

**Created by noodledostuff** | [GitHubプロフィール](https://github.com/noodledostuff)

*インテリジェントなチャット-to-OSCルーティングでストリーミング体験を変革* 🚀
